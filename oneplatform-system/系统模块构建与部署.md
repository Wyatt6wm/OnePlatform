# 系统模块构建与部署

由于涉及到数据库和缓存的连接，在本地容器运行连接远程服务器的测试环境实例，在服务器运行连接生产服务器。构建镜像前，先修改环境标志，如果是在本地运行则修改成`local`，如果是在服务器运行则修改成`run`。删除`target`目录然后 maven install 构建 jar 包。

```yaml
sys:
  env: local / run
```

在项目根目录下构建 Dockerfile，按照如下模板填入构建命令：

```dockerfile
FROM openjdk:15.0.2-oraclelinux8
ADD target/oneplatform-system.jar application.jar
ENTRYPOINT ["java", "-jar", "/application.jar"]
EXPOSE 8002
```

构建镜像并推送到 dockerhub 仓库（注意标签版本号）：

```shell
# 在Dockerfile文件所在目录下运行
docker build -t wyatt6/oneplatform-system:1.0 ./
docker push wyatt6/oneplatform-system:1.0
```

拉取镜像（注意标签版本号）：

```shell
docker network create oneplatform-net
docker pull wyatt6/oneplatform-system:1.0
```

在本地运行用于开发测试时，可以直接运行：

```
docker run --name oneplatform-system -d -p 8002:8002/tcp --net oneplatform-net --restart=unless-stopped -e TZ="Asia/Shanghai" wyatt6/oneplatform-system:1.0
```

在服务运行时，配置文件中包含了数据库密码等敏感信息，因此不能保存到代码仓库。需要在运行前写入`application-run.yaml`配置文件中，上传到服务器`/root/one-platform/config/one-platform-system`目录中。运行容器（注意标签版本号）：

```shell
docker run --name oneplatform-system -v /root/one-platform/config/one-platform-system/application-run.yaml:/application-run.yaml:rw -d -p 8002:8002/tcp --net oneplatform-net --restart=unless-stopped -e TZ="Asia/Shanghai" wyatt6/oneplatform-system:1.0
```

